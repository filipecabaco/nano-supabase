var q=Object.defineProperty;var C=(s,e)=>()=>(s&&(e=s(s=0)),e);var $=(s,e)=>{for(var r in e)q(s,r,{get:e[r],enumerable:!0})};var f={};$(f,{NodeSocket:()=>c,connect:()=>O,listen:()=>W});import{createServer as M}from"node:net";async function O(s,e){let{createConnection:r}=await import("node:net"),t=r({host:s.hostname,port:s.port});return new c(t)}async function W(s){let e=M(r=>{let t=new c(r);s.handler.onConnection(t)});return e.on("error",r=>{s.handler.onError?.(r)}),new Promise(r=>{e.listen(s.port,s.hostname??"0.0.0.0",()=>{r()})})}var c,g=C(()=>{"use strict";c=class{readable;writable;opened;closed;socket;openedResolve;openedReject;closedResolve;constructor(e){this.socket=e,this.opened=new Promise((t,n)=>{this.openedResolve=t,this.openedReject=n}),this.closed=new Promise(t=>{this.closedResolve=t}),this.readable=new ReadableStream({start:t=>{e.on("data",n=>{t.enqueue(new Uint8Array(n))}),e.on("end",()=>{t.close()}),e.on("error",n=>{t.error(n),this.openedReject(n)})},cancel:()=>{e.destroy()}}),this.writable=new WritableStream({write:t=>new Promise((n,o)=>{e.write(t,i=>{i?o(i):n()})||e.once("drain",n)}),close:()=>new Promise(t=>{e.end(()=>t())}),abort:t=>{e.destroy(t instanceof Error?t:new Error(String(t)))}});let r=()=>{let t=e.address(),n=e.remoteAddress,o=e.remotePort;typeof t=="object"&&t&&"address"in t&&"port"in t&&n&&typeof o=="number"&&this.openedResolve({localAddress:{hostname:t.address,port:t.port},remoteAddress:{hostname:n,port:o}})};e.remoteAddress&&e.remotePort?setImmediate(r):e.on("connect",r),e.on("close",()=>{this.closedResolve()})}async close(){return this.socket.destroy(),this.closed}}});import D,{initSchemaFromDb as A}from"native_postgrest_parser/pkg/postgrest_parser.js";import{createClient as U}from"native_postgrest_parser/pkg/client.js";var l=class s{client;static initPromise=null;constructor(){this.client=U()}static async init(){s.initPromise||(s.initPromise=D()),await s.initPromise}static async initSchema(e){await s.init(),await A(e)}parseSelect(e,r=""){return this.parseRequest("GET",e,r)}parseInsert(e,r,t=""){return this.parseRequest("POST",e,t,r)}parseUpdate(e,r,t){return this.parseRequest("PATCH",e,t,r)}parseDelete(e,r){return this.parseRequest("DELETE",e,r)}parseRpc(e,r,t=""){let n=`rpc/${e}`;return this.parseRequest("POST",n,t,r)}parseRequest(e,r,t="",n){let o=this.client.parseRequest(e,r,t,n??null,null);return this.convertResult(o)}convertResult(e){return{sql:e.query,params:Array.isArray(e.params)?e.params:[],tables:Array.isArray(e.tables)?e.tables:[]}}};var p=class{db;parser;constructor(e,r){this.db=e,this.parser=r}from(e){return new m(this.db,this.parser,e)}async rpc(e,r){try{let t=this.parser.parseRpc(e,r);return{data:(await this.db.query(t.sql,[...t.params])).rows,error:null}}catch(t){return{data:null,error:t}}}},m=class{db;parser;table;selectColumns;filters=[];orderBy;limitCount;offsetCount;insertData;updateData;isDelete=!1;expectSingle=!1;expectMaybeSingle=!1;constructor(e,r,t){this.db=e,this.parser=r,this.table=t}select(e="*"){return this.selectColumns=e,this}insert(e){return this.insertData=e,this}update(e){return this.updateData=e,this}delete(){return this.isDelete=!0,this}eq(e,r){return this.filters.push(`${e}=eq.${String(r)}`),this}neq(e,r){return this.filters.push(`${e}=neq.${String(r)}`),this}gt(e,r){return this.filters.push(`${e}=gt.${String(r)}`),this}gte(e,r){return this.filters.push(`${e}=gte.${String(r)}`),this}lt(e,r){return this.filters.push(`${e}=lt.${String(r)}`),this}lte(e,r){return this.filters.push(`${e}=lte.${String(r)}`),this}like(e,r){return this.filters.push(`${e}=like.${r}`),this}ilike(e,r){return this.filters.push(`${e}=ilike.${r}`),this}in(e,r){let t=r.map(String).join(",");return this.filters.push(`${e}=in.(${t})`),this}is(e,r){let t=r===null?"null":r?"true":"false";return this.filters.push(`${e}=is.${t}`),this}order(e,r){let t=r?.ascending===!1?"desc":"asc",n=r?.nullsFirst?"nullsfirst":"nullslast";return this.orderBy=`${e}.${t}.${n}`,this}limit(e){return this.limitCount=e,this}range(e,r){return this.offsetCount=e,this.limitCount=r-e+1,this}single(){return this.expectSingle=!0,this.limitCount=1,this}maybeSingle(){return this.expectMaybeSingle=!0,this.limitCount=1,this}async then(e){let r=await this.execute();return e?e(r):r}async execute(){try{let e=this.buildQueryString(),r;if(this.insertData!==void 0){let o=Array.isArray(this.insertData)?this.insertData[0]??{}:this.insertData;r=this.parser.parseInsert(this.table,o,e)}else this.updateData!==void 0?r=this.parser.parseUpdate(this.table,this.updateData,e):this.isDelete?r=this.parser.parseDelete(this.table,e):r=this.parser.parseSelect(this.table,e);let t=await this.db.query(r.sql,[...r.params]);if(this.expectSingle&&t.rows.length===0)throw new Error("No rows returned");if(this.expectSingle&&t.rows.length>1)throw new Error("Multiple rows returned");return{data:this.expectSingle||this.expectMaybeSingle?t.rows[0]??null:t.rows,error:null}}catch(e){return{data:null,error:e}}}buildQueryString(){let e=[];return this.selectColumns&&e.push(`select=${this.selectColumns}`),e.push(...this.filters),this.orderBy&&e.push(`order=${this.orderBy}`),this.limitCount!==void 0&&e.push(`limit=${this.limitCount}`),this.offsetCount!==void 0&&e.push(`offset=${this.offsetCount}`),e.join("&")}};async function I(s){await l.init(),await l.initSchema(async r=>({rows:(await s.query(r)).rows}));let e=new l;return new p(s,e)}import{randomUUID as j}from"node:crypto";var d=class{queues;maxSize;constructor(e=1e3){this.maxSize=e,this.queues=new Map([[0,[]],[1,[]],[2,[]],[3,[]]])}enqueue(e){let r=this.queues.get(e.priority);if(!r)throw new Error(`Invalid priority: ${e.priority}`);if(this.size()>=this.maxSize)throw new Error("Queue is full");r.push(e)}dequeue(){for(let e of[0,1,2,3]){let r=this.queues.get(e);if(r&&r.length>0)return r.shift()??null}return null}size(){return Array.from(this.queues.values()).reduce((e,r)=>e+r.length,0)}isEmpty(){return this.size()===0}clear(){for(let e of this.queues.values())e.length=0}};var y=class{db;queue;running=!1;config;constructor(e,r={}){this.db=e,this.queue=new d(r.maxQueueSize??1e3),this.config={maxQueueSize:r.maxQueueSize??1e3,defaultTimeout:r.defaultTimeout??5e3}}async start(){if(this.running)throw new Error("Pooler already started");this.running=!0,setImmediate(()=>{this.processQueue().catch(e=>{console.error("Queue processor error:",e),this.running=!1})}),await new Promise(e=>setImmediate(e))}async stop(){this.running=!1}async query(e,r,t=2){return new Promise((n,o)=>{let a={id:j(),sql:e,params:r,priority:t,enqueuedAt:Date.now(),resolve:n,reject:o,timeoutMs:this.config.defaultTimeout};try{this.queue.enqueue(a)}catch(i){o(i instanceof Error?i:new Error(String(i)))}})}async processQueue(){for(;this.running;){let e=this.queue.dequeue();if(!e){await new Promise(r=>setTimeout(r,10));continue}try{let r=await this.executeWithTimeout(e);e.resolve(r)}catch(r){e.reject(r instanceof Error?r:new Error(String(r)))}}}async executeWithTimeout(e){let r=e.timeoutMs??this.config.defaultTimeout,t=null,n=new Promise((a,i)=>{t=setTimeout(()=>{i(new Error("Query timeout"))},r)}),o=this.db.query(e.sql,e.params).finally(()=>{t&&clearTimeout(t)});return Promise.race([o,n])}};function h(){return typeof Deno<"u"&&Deno?.version?.deno?"deno":typeof Bun<"u"&&Bun?.version?"bun":typeof navigator<"u"&&navigator.userAgent==="Cloudflare-Workers"?"workerd":typeof process<"u"&&process.versions?.node?"node":"unknown"}var u=h(),T=u==="node",b=u==="deno",k=u==="bun",R=u==="workerd";async function G(s,e){switch(u){case"node":{let{connect:r}=await Promise.resolve().then(()=>(g(),f));return r(s,e)}case"deno":throw new Error("Deno adapter not yet implemented");case"bun":throw new Error("Bun adapter not yet implemented");case"workerd":throw new Error("Cloudflare Workers adapter not yet implemented");default:throw new Error(`Unsupported runtime: ${u}`)}}async function w(s){switch(u){case"node":{let{listen:e}=await Promise.resolve().then(()=>(g(),f));return e(s)}case"deno":throw new Error("Deno adapter not yet implemented");case"bun":throw new Error("Bun adapter not yet implemented");case"workerd":throw new Error("Cloudflare Workers does not support TCP servers (outbound only)");default:throw new Error(`Unsupported runtime: ${u}`)}}var v=(n=>(n[n.CRITICAL=0]="CRITICAL",n[n.HIGH=1]="HIGH",n[n.MEDIUM=2]="MEDIUM",n[n.LOW=3]="LOW",n))(v||{});var S=class{config;clients=new Set;constructor(e){this.config=e}async start(){await this.config.pooler.start(),await w({hostname:this.config.hostname??"0.0.0.0",port:this.config.port,handler:{onConnection:e=>this.handleConnection(e),onError:e=>console.error("[Server] Error:",e)}}),console.log(`[Server] Listening on ${this.config.hostname??"0.0.0.0"}:${this.config.port}`)}async stop(){await this.config.pooler.stop(),console.log("[Server] Stopped")}async handleConnection(e){let r=await e.opened,t=`${r.remoteAddress.hostname}:${r.remoteAddress.port}`;this.clients.add(t),console.log(`[Server] Client connected: ${t}`);try{await this.processQueries(e,t)}catch(n){console.error(`[Server] Error handling client ${t}:`,n)}finally{this.clients.delete(t),console.log(`[Server] Client disconnected: ${t}`)}}async processQueries(e,r){let t=e.readable.getReader(),n=e.writable.getWriter(),o=new TextDecoder,a=new TextEncoder,i="";try{for(;;){let{done:x,value:B}=await t.read();if(x)break;i+=o.decode(B,{stream:!0});let Q=i.split(`
`);i=Q.pop()??"";for(let E of Q){let P=E.trim();P&&await this.handleQuery(n,a,r,P)}}}finally{t.releaseLock(),n.releaseLock()}}async handleQuery(e,r,t,n){try{let o=await this.config.pooler.query(n,[],2),a=JSON.stringify({status:"success",rows:o.rows,rowCount:o.rows.length,fields:o.fields});await e.write(r.encode(a+`
`))}catch(o){let a=JSON.stringify({status:"error",message:o instanceof Error?o.message:String(o)});await e.write(r.encode(a+`
`))}}getClients(){return Array.from(this.clients)}};export{y as PGlitePooler,S as PGliteServer,l as PostgrestParser,d as PriorityQueue,v as QueryPriority,u as RUNTIME,p as SupabaseClient,G as connect,I as createSupabaseClient,h as detectRuntime,k as isBun,b as isDeno,T as isNode,R as isWorkerd,w as listen};
//# sourceMappingURL=index.js.map
